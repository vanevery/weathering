<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->

        <!--
		HTML5 Audio barely works
		PhoneGap Media barely works
		PGLowLatencyAudio missing volume control
		Native Audio has volume control - Using it
    	-->

        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
		<style>	
      		
      		#map {
        		height: 700px;
      		}
    	</style>

        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript">

        	var LOCATIONS_JSON = "http://www.walking-productions.com/weathering/assets/weathering.json";

        	var MAX_DISTANCE = .050; // KM  .1 is 100 meters

        	var FADE_INTERVAL = 200; // milliseconds

        	var latCenter = 42.345762;
        	var lngCenter = -71.093623;
        	var diffLat = 0;
        	var diffLng = 0;
        	var currentLat = 0;
			var currentLng = 0;

			var locations = [];
/*
			[
			

				{lat: 42.338853, lng: -71.096248, label: "Richardson Bridge metal plate VG", audio: "audio/atmos1.mp3", bounds: [{lat: 42.338602, lng: -71.098183}, {lat: 42.338285, lng: -71.097518}, {lat: 42.338689, lng: -71.097207}, {lat: 42.338998, lng: -71.097636}, {lat: 42.339006, lng: -71.097926}], volume: 0, fadein: false, fadeout: false, fadeintime: 2000, fadeouttime: 3000, fadeTimeout: null},

				{lat: 42.345762, lng: -71.093623, label: "Huge Willow Tree VG", audio: "audio/atmos2.mp3", bounds: [{lat: 42.345991, lng: -71.093578}, {lat: 42.345773, lng: -71.093229}, {lat: 42.345582, lng: -71.093449}, {lat: 42.345783, lng: -71.093787}], volume: 0, fadein: false, fadeout: false, fadeintime: 2000, fadeouttime: 3000, fadeTimeout: null},

				{lat: 42.345653, lng: -71.093658, label: "Huge Oak Tree VG", audio: "audio/FENE-40_01.mp3", bounds: [{lat: 42.345683, lng: -71.0939}, {lat: 42.345842, lng: -71.093726}, {lat: 42.345636, lng: -71.093382}, {lat: 42.345489, lng: -71.093591}], volume: 0, fadein: false, fadeout: false, fadeintime: 2000, fadeouttime: 3000, fadeTimeout: null},

				{lat: 42.345610, lng: -71.093169, label: "Elm Bark Beetle Map VG", audio: "audio/story1.mp3", bounds: [{lat: 42.345808, lng: -71.09328}, {lat: 42.345675, lng: -71.093449}, {lat: 42.345555, lng: -71.09328}, {lat: 42.345697, lng: -71.093101}], volume: 0, fadein: false, fadeout: false, fadeintime: 2000, fadeouttime: 3000, fadeTimeout: null},

				{lat: 42.345772, lng: -71.093009, label: "Dawn Redwood", audio: "audio/story2.mp3", bounds: [{lat: 42.345862, lng: -71.093017}, {lat: 42.345699, lng: -71.093229}, {lat: 42.345551, lng: -71.09302}, {lat: 42.345711, lng: -71.092808}], volume: 0, fadein: false, fadeout: false, fadeintime: 2000, fadeouttime: 3000, fadeTimeout: null}
			];
*/

			var map, marker;
			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {lat: latCenter, lng: lngCenter},
					zoom: 18
				});

				marker = new google.maps.Marker({
					position: {lat: latCenter, lng: lngCenter},
					map: map,
					title: 'X'
				});

				for (var i = 0; i < locations.length; i++) {
					var polygon = new google.maps.Polygon({
						paths: locations[i].bounds,
						strokeColor: '#FF0000',
						strokeOpacity: 0.8,
						strokeWeight: 2,
						fillColor: '#FF0000',
						fillOpacity: 0.35
					});
					polygon.setMap(map);
				}
			}

			function log(message) {
				document.getElementById('log').innerHTML = message + " " + document.getElementById('log').innerHTML;

				console.log(message);
			}

        	function recenter() {
				diffLat = latCenter - currentLat;
    	    	diffLng = lngCenter - currentLng;

        		log(diffLat + " " + diffLng);
    	    }
        			
        	/*
        	function changeDistance(dist) {
        		MAX_DISTANCE = dist;
        		document.getElementById('dist').innerHTML = dist;
        		log(MAX_DISTANCE);

        		update();
        	}	
			*/

			function fadeOut(index) {
				// If we have a fadein going on, cancel it
				if (locations[index].fadein) {
					locations[index].fadein = false;

					// Clear any existing fadeIn or fadeOut timeouts
					if (locations[index].fadeTimeout != null) {
						clearTimeout(locations[index].fadeTimeout);
						locations[index].fadeTimeout = null;
					}
				}
				else
				{
					// If we are greater than 0 then we can do a fadeout
					if (locations[index].volume > 0) {

						log("fadeOut " + locations[index]);

						// set fadeout to true so know what's up
						locations[index].fadeout = true;

						// Lower the volume
						locations[index].volume = locations[index].volume - FADE_INTERVAL/locations[index].fadeouttime;
														//1/(location.fadeouttime/FADE_INTERVAL);

						// Set the timeout to actually do the volume lowering
						var fadeTimeout = setTimeout(function() {
							window.plugins.NativeAudio.setVolumeForComplexAsset(index,locations[index].volume,	function(message){log(message);}, function(error){log(error);});
							// Call the fadeOut again	
							fadeOut(index);
							// After a set interval
						},FADE_INTERVAL);

						// Store the timeout object
						locations[index].fadeTimeout = fadeTimeout;
					} else {
						// Otherwise we are done and we'll set fadeout to false
						locations[index].fadeout = false;
					}
				}
			}

			function fadeIn(index) {

				// If we have a fadeout going on, cancel it
				if (locations[index].fadeout) {
					locations[index].fadeout = false;

					// Clear any existing fadeIn or fadeOut timeouts
					if (locations[index].fadeTimeout != null) {
						clearTimeout(locations[index].fadeTimeout);
						locations[index].fadeTimeout = null;
					}
				}
				else
				{
					// If we don't have a fadeout going on, do a fade in

					// If we are less than 1 then we can do a fadein
					if (locations[index].volume < 1) {
						log("fadeIn " + locations[index]);
	
						// set fadeout to true so know what's up
						locations[index].fadein = true;

						// Lower the volume
						locations[index].volume = locations[index].volume + FADE_INTERVAL/locations[index].fadeintime;
														//1/(location.fadeouttime/FADE_INTERVAL);

						// Set the timeout to actually do the volume lowering
						var fadeTimeout = setTimeout(function() {
							window.plugins.NativeAudio.setVolumeForComplexAsset(index,locations[index].volume,	function(message){log(message);}, function(error){log(error);});
							// Call the fadeOut again	
							fadeIn(index);
							// After a set interval
						},FADE_INTERVAL);

						// Store the timeout object
						locations[index].fadeTimeout = fadeTimeout;
					} else {
						// Otherwise we are done and we'll set fadein to false
						locations[index].fadein = false;
					}
				}
			}

        	function update(pos) {
				for (var i = 0; i < locations.length; i++) {
					if (inside(pos, locations[i].bounds)) {
						if (locations[i].volume != 1 && locations[i].fadein == false) {
							fadeIn(i);
						}
					} else {
						if (locations[i].volume != 0 && locations[i].fadeout == false) {
							fadeOut(i);
						}
					}
				}        		
        	}

			function inside(point, vs) {
			    var inside = false;
			    var y = point.lat;
			    var x = point.lng;

    			for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
        			var xi = vs[i].lng, yi = vs[i].lat;
        			var xj = vs[j].lng, yj = vs[j].lat;
        
        			var intersect = ((yi > y) != (yj > y))
            			&& (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        			if (intersect) inside = !inside;
    			}
    			return inside;
			};

			function geoDistance(lat1, lng1, lat2, lng2, unit) {
			    var radlat1 = Math.PI * lat1/180
			    var radlat2 = Math.PI * lat2/180
			    var radlng1 = Math.PI * lng1/180
			    var radlng2 = Math.PI * lng2/180
			    var theta = lng1-lng2
			    var radtheta = Math.PI * theta/180
			    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
			    dist = Math.acos(dist)
			    dist = dist * 180/Math.PI
			    dist = dist * 60 * 1.1515
			    if (unit=="K") { dist = dist * 1.609344 }
			    if (unit=="N") { dist = dist * 0.8684 }
			    return dist
			}
        	
        	var count = 0;
			function locationWatchPositionCallback(currentPosition) 
            {
           		//log("locationWatchPositionCallback"+count);           		
           		count++;

            	currentLat = currentPosition.coords.latitude;
				currentLng = currentPosition.coords.longitude;

				currentLat += diffLat;
				currentLng += diffLng;

				document.getElementById('currentLocation').innerHTML = currentLat + " " + currentLng;

				var mapPos = {
			        lat: currentLat,
        			lng: currentLng
      			};					
				map.setCenter(mapPos);
      			marker.setPosition(mapPos);

				update(mapPos);

				setTimeout(
					function() { 
						navigator.geolocation.getCurrentPosition(locationWatchPositionCallback, locationWatchPositionErrorCallback, 
                			{ maximumAge: 3000, timeout: 3000, enableHighAccuracy: true });
					}, 
					2000);

			}

            function locationWatchPositionErrorCallback(e) {
 	          	log(e);
				setTimeout(
					function() { 
						navigator.geolocation.getCurrentPosition(locationWatchPositionCallback, locationWatchPositionErrorCallback, 
                			{ maximumAge: 3000, timeout: 3000, enableHighAccuracy: true });
					}, 
					5000); 	          
            }

            function loadLocations(completeCallback) {
				//http://www.sitepoint.com/guide-vanilla-ajax-without-jquery/
				var oReq = new XMLHttpRequest();
				oReq.onload = function (e) {
					console.log(e.target.response);
				    locations = JSON.parse(e.target.response);
				    console.log(locations);
				    completeCallback();
				};
				oReq.open('GET', LOCATIONS_JSON + '?' + new Date().getTime(), true);
				//oReq.responseType = 'json';
				oReq.send();				
            }

			function onWindowLoad() {
				document.addEventListener('deviceready', onDeviceReady);
			}
	
			function onDeviceReady() {
				log("onDeviceReady");

				// Load Locations
				loadLocations(
					function() {

						// Should switch to foreach
						function createPreloadSuccessCallback(closed_i) {
							return function(message) {
								log("Preload " + closed_i + " " + message);

								window.plugins.NativeAudio.loop(closed_i,
									function(message) {
										log(message);
									}, 
									function(error){
										log(error);
									}
								);
							};
						}

						for (var i = 0; i < locations.length; i++) {

							/*
							window.plugins.NativeAudio.preloadComplex(i, 
								locations[i].audio, 0.0, 1, 0, 
								createPreloadSuccessCallback(i), 
								function(error){
									log(error);
								}
							);
							*/

							window.plugins.NativeAudio.preloadComplex(i, 
								locations[i].audio, 0.0, 1, 0, 
								createPreloadSuccessCallback(i), 
								function(error){
									log(error);
								}
							);
							
							var div = document.createElement("div");
							div.setAttribute("id","location"+i);
							document.getElementById("locations").appendChild(div);
						}				

		                if (navigator.geolocation) 
		                {
		                	log("navigator.geolocation");

							navigator.geolocation.getCurrentPosition(locationWatchPositionCallback, locationWatchPositionErrorCallback, 
		                		{ maximumAge: 3000, timeout: 3000, enableHighAccuracy: true });
		                    
		                }

					}
				);
			}
	
			window.addEventListener('load', onWindowLoad);

        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBTOCpIOhRAtMINhn-wBLTlSl6S8bG1gsg&callback=initMap" async defer></script>

        <title>Weathering</title>
    </head>
    <body>
        <div>
            <h1>Weathering</h1>
		    <div id="map"></div>
			<div id="locations"></div>		    
			<div id="currentLocation"></div>
			<br /><br />
			<button id="center" onclick="recenter();">Recenter</button>
			<div id="log"></div>
        </div>
    </body>
</html>
