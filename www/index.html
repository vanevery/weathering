<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->

        <!--
		HTML5 Audio barely works
		PhoneGap Media barely works
		PGLowLatencyAudio missing volume control
		Native Audio has volume control for Android - need to check iOS
    	-->

        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript">
        	var MAX_DISTANCE = .2; // Miles

			var audioTracks = [
				"audio/0.mp3",
				"audio/1.mp3"
			];

			var locations = [
				{lat: 40.68819612, lon: -74.00101029},
				{lat: 40.68950567, lon: -73.99925103}
			];

        	var tracks = [
        		{audio: audioTracks[0], location: locations[0]},
        		{audio: audioTracks[1], location: locations[1]}
        	];

			function geoDistance(lat1, lon1, lat2, lon2, unit) {
			    var radlat1 = Math.PI * lat1/180
			    var radlat2 = Math.PI * lat2/180
			    var radlon1 = Math.PI * lon1/180
			    var radlon2 = Math.PI * lon2/180
			    var theta = lon1-lon2
			    var radtheta = Math.PI * theta/180
			    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
			    dist = Math.acos(dist)
			    dist = dist * 180/Math.PI
			    dist = dist * 60 * 1.1515
			    if (unit=="K") { dist = dist * 1.609344 }
			    if (unit=="N") { dist = dist * 0.8684 }
			    return dist
			}
        
			function onWindowLoad() {
				document.addEventListener('deviceready', onDeviceReady);

			}
	
			function onDeviceReady() {
				console.log("onDeviceReady");


				for (var i = 0; i < tracks.length; i++) {

					window.plugins.NativeAudio.preloadSimple(i, tracks[i].audio, 1, function(message){console.log(message);}, function(error){console.log(error);});
					window.plugins.NativeAudio.loop(i,function(message){console.log("success");}, function(error){console.log(error);});

				}				

                if (navigator.geolocation) 
                {
                	console.log("navigator.geolocation");

                	navigator.geolocation.watchPosition(locationWatchPositionCallback, locationWatchPositionErrorCallback, 
                		{ maximumAge: 3000, timeout: 5000, enableHighAccuracy: true });

                   function locationWatchPositionCallback(currentPosition) 
                   {
                   		console.log("locationWatchPositionCallback");

	                	var currentLat = currentPosition.coords.latitude;
						var currentLon = currentPosition.coords.longitude;

						console.log(currentLat + " " + currentLon);

						document.getElementById('currentLocation').innerHTML = currentLat + " " + currentLon;

						for (var i = 0; i < tracks.length; i++) {
							var distance = geoDistance(currentLat, currentLon, tracks[i].location.lat, tracks[i].location.lon, 'M');

							var volume = 1 - distance/MAX_DISTANCE;

							if (volume < 0) { volume = 0; } 
							else if (volume > 1) { volume = 1; }

							window.plugins.NativeAudio.setVolumeForComplexAsset(i,volume,function(message){console.log(message);}, function(error){console.log(error);});
							//tracks[i].element.setVolume(volume);

							//if (volume > 0 && tracks[i].element.paused) {
								//tracks[i].element.play(MEDIA_PLAY_OPTIONS);
								//console.log("Triggering Play: " + i);
							//} else if (volume == 0) {
								//tracks[i].element.pause();
								//console.log("Triggering Pause: " + i);
							//}

							console.log("Distance to track " + i + " " + distance + " volume: " + volume);

							document.getElementById('track'+i+"volume").innerHTML = "D: " + Number((distance).toFixed(2)) + " V: " + Number((volume).toFixed(2));

						}
				   
					}

                   function locationWatchPositionErrorCallback(e) {
         	          console.log(e);
                   }
                }
		
		/*
		if( window.plugins && window.plugins.NativeAudio ) {

    			// Preload audio resources
    			window.plugins.NativeAudio.preloadComplex('music', 'audio/music.mp3', 1, 1, 0, 
				function(msg){
					console.log('success: ' + msg);

    			 		window.plugins.NativeAudio.play('music',
						function (msg) {
							console.log('play success ' + msg);
						}, 
						function (msg) {
							console.log('play error ' + msg);
						}
			 		);
    				},

				function(msg) {
        				console.log('error: ' + msg );
    				}
			);

    			window.plugins.NativeAudio.preloadSimple( 'click', 'audio/other.mp3', function(msg){
    				}, function(msg){
        				console.log( 'error: ' + msg );
    				}
			);


    			// Play
    			//window.plugins.NativeAudio.play( 'click' );

    			// Stop multichannel clip after 60 seconds
    			window.setTimeout( function(){

        			window.plugins.NativeAudio.stop( 'music' );
        			window.plugins.NativeAudio.unload( 'music' );
        			window.plugins.NativeAudio.unload( 'click' );

    			}, 1000 * 60 );
		}
		*/

			}
	
			window.addEventListener('load', onWindowLoad);

        </script>
        <title>Weathering</title>
    </head>
    <body>
        <div>
            <h1>Weathering</h1>
			
			<div id="track0div"><div id="track0volume"></div><div>

			<br /><br />
			
			<div id="track1div"><div id="track1volume"></div></div>

			<br /><br />

			<div id="currentLocation"></div>
        </div>
    </body>
</html>
